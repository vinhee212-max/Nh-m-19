<!doctype html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nhom_19_WSN</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#eef2ff}
header{
  background:#2563eb;color:white;
  padding:16px 24px;
  display:flex;justify-content:space-between;align-items:center
}
button{
  background:#22c55e;border:none;color:white;
  padding:10px 16px;font-weight:700;border-radius:8px
}
.grid{
  max-width:1800px;margin:20px auto;padding:0 16px;
  display:grid;grid-template-columns:repeat(4,1fr);gap:20px
}
.card{
  background:white;border-radius:18px;padding:18px;
  box-shadow:0 12px 30px rgba(0,0,0,.12)
}
.card.alert{
  border:4px solid #ef4444;
  background:#fff1f2;
}
.metrics{
  display:grid;grid-template-columns:repeat(3,1fr);
  text-align:center;margin-bottom:10px
}
.value{font-size:30px;font-weight:800}
.temp{color:#ef4444}
.hum{color:#3b82f6}
.soil{color:#8b5cf6}
canvas{height:220px!important}
</style>
</head>

<body>

<header>
  <h2>ESP32 Environmental Dashboard (4 Nodes)</h2>
  <button onclick="exportExcel()">‚¨á Xu·∫•t Excel</button>
</header>

<div class="grid" id="grid"></div>

<script>
/* ====== CONFIG ====== */
const HOST="a736019f2a5e4fd98c17a4115be133f0.s1.eu.hivemq.cloud";
const USERNAME="Nhom19WSN";
const PASSWORD="Aenhom19@";
const TOPIC="nodes/+/data";
const TEMP_LIMIT = 18; // üî• TEST NG∆Ø·ª†NG 18
/* =================== */

const charts={}, excelData=[];
const grid=document.getElementById("grid");

// UI 4 NODE GI·ªêNG H·ªÜT
for(let i=1;i<=4;i++){
  grid.innerHTML+=`
  <div class="card" id="card${i}">
    <h3>Node ${i}</h3>
    <div class="metrics">
      <div><div>Nhi·ªát ƒë·ªô</div><div id="t${i}" class="value temp">--¬∞C</div></div>
      <div><div>ƒê·ªô ·∫©m KK</div><div id="h${i}" class="value hum">--%</div></div>
      <div><div>ƒê·ªô ·∫©m ƒë·∫•t</div><div id="s${i}" class="value soil">--%</div></div>
    </div>
    <canvas id="c${i}"></canvas>
  </div>`;
}

// CHART
for(let i=1;i<=4;i++){
  charts[i]=new Chart(document.getElementById(`c${i}`),{
    type:"line",
    data:{labels:[],datasets:[
      {label:"Temp ¬∞C",data:[],borderColor:"#ef4444",tension:.4},
      {label:"Hum %",data:[],borderColor:"#3b82f6",tension:.4},
      {label:"Soil %",data:[],borderColor:"#8b5cf6",tension:.4}
    ]},
    options:{responsive:true,animation:false,scales:{y:{min:0,max:100}}}
  });
}

// MQTT
const client=mqtt.connect(`wss://${HOST}:8884/mqtt`,{
  username:USERNAME,password:PASSWORD,reconnectPeriod:2000
});
client.on("connect",()=>client.subscribe(TOPIC));

client.on("message",(topic,msg)=>{
  const payload=JSON.parse(msg.toString());
  if(!payload.data) return;

  payload.data.slice(0,4).forEach((d,index)=>{
    const node=index+1;
    const t=Number(d.t), h=Number(d.h), s=Number(d.s);

    document.getElementById(`t${node}`).innerHTML=t.toFixed(1)+"¬∞C";
    document.getElementById(`h${node}`).innerHTML=h.toFixed(1)+"%";
    document.getElementById(`s${node}`).innerHTML=s.toFixed(1)+"%";

    // üî• ALERT ‚Äì ƒê·∫¢M B·∫¢O CH·∫†Y
    const card=document.getElementById(`card${node}`);
    if(t>=TEMP_LIMIT){
      card.classList.add("alert");
    }else{
      card.classList.remove("alert");
    }

    const chart=charts[node];
    const time=new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(t);
    chart.data.datasets[1].data.push(h);
    chart.data.datasets[2].data.push(s);
    if(chart.data.labels.length>30){
      chart.data.labels.shift();
      chart.data.datasets.forEach(ds=>ds.data.shift());
    }
    chart.update();

    excelData.push({
      Time:new Date().toLocaleString(),
      Node:node,Temp:t,Hum:h,Soil:s
    });
  });
});

// EXCEL
function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(excelData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Data");
  XLSX.writeFile(wb,"ESP32_4Node_Data.xlsx");
}
</script>

</body>
</html>
