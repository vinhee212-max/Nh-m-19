<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 DHT22 Dashboard - Multiple Nodes</title>
  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:linear-gradient(to bottom, #f0f4f8, #d9e2ec); color:#333;}
    header {background:linear-gradient(to right, #1e3a8a, #3b82f6); color:#fff; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    .header-content {display:flex; justify-content:space-between; align-items:center; max-width:1200px; margin:auto; flex-wrap:wrap; gap:16px;}
    .header-title {font-size:24px; font-weight:bold;}
    .header-subtitle {font-size:14px; opacity:0.8;}
    .wrap {padding:24px; max-width:1200px; margin:auto;}
    .nodes-grid {display:grid; grid-template-columns:repeat(auto-fit, minmax(350px, 1fr)); gap:24px;}
    .node-section {background:#fff; border-radius:16px; padding:20px; box-shadow:0 8px 20px rgba(0,0,0,0.1); transition:transform 0.2s;}
    .node-section:hover {transform:translateY(-4px);}
    .node-title {font-size:20px; font-weight:700; margin-bottom:16px; color:#1e40af; display:flex; align-items:center; gap:8px;}
    .node-title::before {content:''; width:8px; height:8px; background:#3b82f6; border-radius:50%;}
    .row {display:flex; gap:16px; flex-wrap:wrap; margin-bottom:20px;}
    .card {background:linear-gradient(to bottom, #ffffff, #f9fafb); border-radius:12px; padding:16px; flex:1; min-width:140px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.05);}
    .big {font-size:40px; font-weight:800; display:flex; align-items:center; justify-content:center; gap:4px;}
    .unit {font-size:20px; font-weight:400;}
    .muted {color:#6b7280; font-size:14px; margin-bottom:8px;}
    .status {display:flex; align-items:center; gap:12px;}
    .dot {width:12px; height:12px; border-radius:50%; transition:background 0.3s;}
    .ok {background:#22c55e;}
    .bad {background:#ef4444;}
    canvas {background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05);}
    .temp-color {color:#ef4444;}
    .hum-color {color:#3b82f6;}
  </style>
</head>
<body>
<header>
  <div class="header-content">
    <div>
      <div class="header-title">Dashboard ESP32 DHT22</div>
      <div class="header-subtitle">Monitoring Multiple Nodes • Topics: esp32/dht22/1, /2, /3</div>
    </div>
    <div class="status">
      <div id="dot" class="dot bad"></div>
      <div>
        <div id="connText" style="font-weight:700;">Disconnected</div>
        <div id="lastMsg" class="muted">Last msg: --</div>
      </div>
    </div>
  </div>
</header>
<div class="wrap">
  <div class="nodes-grid">
    <!-- Node 1 -->
    <div class="node-section" id="node1">
      <div class="node-title">Node 1</div>
      <div class="row">
        <div class="card">
          <div class="muted">Nhiệt độ (°C)</div>
          <div id="tempText1" class="big temp-color">-- <span class="unit">°C</span></div>
        </div>
        <div class="card">
          <div class="muted">Độ ẩm (%)</div>
          <div id="humText1" class="big hum-color">-- <span class="unit">%</span></div>
        </div>
      </div>
      <div class="row">
        <div class="card" style="flex:1;">
          <div style="font-weight:700; margin-bottom:10px; color:#ef4444;">Đồ thị Nhiệt độ</div>
          <canvas id="tempChart1"></canvas>
        </div>
        <div class="card" style="flex:1;">
          <div style="font-weight:700; margin-bottom:10px; color:#3b82f6;">Đồ thị Độ ẩm</div>
          <canvas id="humChart1"></canvas>
        </div>
      </div>
    </div>

    <!-- Node 2 -->
    <div class="node-section" id="node2">
      <div class="node-title">Node 2</div>
      <div class="row">
        <div class="card">
          <div class="muted">Nhiệt độ (°C)</div>
          <div id="tempText2" class="big temp-color">-- <span class="unit">°C</span></div>
        </div>
        <div class="card">
          <div class="muted">Độ ẩm (%)</div>
          <div id="humText2" class="big hum-color">-- <span class="unit">%</span></div>
        </div>
      </div>
      <div class="row">
        <div class="card" style="flex:1;">
          <div style="font-weight:700; margin-bottom:10px; color:#ef4444;">Đồ thị Nhiệt độ</div>
          <canvas id="tempChart2"></canvas>
        </div>
        <div class="card" style="flex:1;">
          <div style="font-weight:700; margin-bottom:10px; color:#3b82f6;">Đồ thị Độ ẩm</div>
          <canvas id="humChart2"></canvas>
        </div>
      </div>
    </div>

    <!-- Node 3 -->
    <div class="node-section" id="node3">
      <div class="node-title">Node 3</div>
      <div class="row">
        <div class="card">
          <div class="muted">Nhiệt độ (°C)</div>
          <div id="tempText3" class="big temp-color">-- <span class="unit">°C</span></div>
        </div>
        <div class="card">
          <div class="muted">Độ ẩm (%)</div>
          <div id="humText3" class="big hum-color">-- <span class="unit">%</span></div>
        </div>
      </div>
      <div class="row">
        <div class="card" style="flex:1;">
          <div style="font-weight:700; margin-bottom:10px; color:#ef4444;">Đồ thị Nhiệt độ</div>
          <canvas id="tempChart3"></canvas>
        </div>
        <div class="card" style="flex:1;">
          <div style="font-weight:700; margin-bottom:10px; color:#3b82f6;">Đồ thị Độ ẩm</div>
          <canvas id="humChart3"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
/* ================== SỬA 3 CHỖ NÀY ================== */
const HOST = "a736019f2a5e4fd98c17a4115be133f0.s1.eu.hivemq.cloud";
const USERNAME = "YOUR_MQTT_USERNAME";
const PASSWORD = "YOUR_MQTT_PASSWORD";
/* =================================================== */
const WS_PORT = 8884;
const brokerUrl = `wss://${HOST}:${WS_PORT}/mqtt`;
const TOPICS = ["esp32/dht22/1", "esp32/dht22/2", "esp32/dht22/3"];
// UI elements
const dot = document.getElementById("dot");
const connText = document.getElementById("connText");
const lastMsg = document.getElementById("lastMsg");
// Data buffers (one per node)
const MAX_POINTS = 60;
const nodeData = [
  { labels: [], tempData: [], humData: [], tempText: document.getElementById("tempText1"), humText: document.getElementById("humText1"), tempChart: null, humChart: null },
  { labels: [], tempData: [], humData: [], tempText: document.getElementById("tempText2"), humText: document.getElementById("humText2"), tempChart: null, humChart: null },
  { labels: [], tempData: [], humData: [], tempText: document.getElementById("tempText3"), humText: document.getElementById("humText3"), tempChart: null, humChart: null }
];
// Initialize charts
nodeData.forEach((node, index) => {
  node.tempChart = new Chart(document.getElementById(`tempChart${index+1}`), {
    type: "line",
    data: {
      labels: node.labels,
      datasets: [{
        label: "Temp (°C)",
        data: node.tempData,
        borderColor: "#ef4444",
        backgroundColor: "rgba(239,68,68,0.1)",
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      animation: { duration: 300 },
      scales: {
        y: { beginAtZero: false }
      }
    }
  });
  node.humChart = new Chart(document.getElementById(`humChart${index+1}`), {
    type: "line",
    data: {
      labels: node.labels,
      datasets: [{
        label: "Hum (%)",
        data: node.humData,
        borderColor: "#3b82f6",
        backgroundColor: "rgba(59,130,246,0.1)",
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      animation: { duration: 300 },
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });
});
// MQTT connect
const client = mqtt.connect(brokerUrl, {
  username: USERNAME,
  password: PASSWORD,
  clean: true,
  connectTimeout: 8000,
  reconnectPeriod: 2000,
  keepalive: 30
});
client.on("connect", () => {
  setConnected(true);
  TOPICS.forEach(topic => client.subscribe(topic));
});
client.on("reconnect", () => setConnected(false, "Reconnecting..."));
client.on("close", () => setConnected(false));
client.on("error", () => setConnected(false, "Error"));
client.on("message", (topic, msg) => {
  try {
    const data = JSON.parse(msg.toString());
    const t = Number(data.temp);
    const h = Number(data.hum);
    // Determine node index from topic
    const nodeIndex = TOPICS.findIndex(t => topic === t);
    if (nodeIndex === -1) return;
    const node = nodeData[nodeIndex];
    // Update text
    node.tempText.innerHTML = `${t.toFixed(2)} <span class="unit">°C</span>`;
    node.humText.innerHTML = `${h.toFixed(2)} <span class="unit">%</span>`;
    // Update time label (global last msg)
    const now = new Date();
    lastMsg.textContent = "Last msg: " + now.toLocaleTimeString();
    // Push to buffer
    node.labels.push(now.toLocaleTimeString());
    node.tempData.push(t);
    node.humData.push(h);
    // Limit points
    if (node.labels.length > MAX_POINTS) {
      node.labels.shift();
      node.tempData.shift();
      node.humData.shift();
    }
    // Update charts
    node.tempChart.update();
    node.humChart.update();
  } catch (e) {
    console.log("JSON parse error:", e);
  }
});
function setConnected(ok, text=null){
  if(ok){
    dot.classList.remove("bad"); dot.classList.add("ok");
    connText.textContent = text || "Connected";
  }else{
    dot.classList.remove("ok"); dot.classList.add("bad");
    connText.textContent = text || "Disconnected";
  }
}
</script>
</body>
</html>