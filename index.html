<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Nhom_19_WSN</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #eef2fb;
}

header {
    background: #2563eb;
    color: white;
    padding: 18px 30px;
    font-size: 26px;
    font-weight: bold;
}

.toolbar {
    padding: 15px 30px;
}

button {
    padding: 10px 16px;
    font-size: 14px;
    background: #16a34a;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

.grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    padding: 20px 30px;
}

.card {
    background: white;
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
}

.card.alert {
    border: 3px solid red;
}

.card h3 {
    margin: 0 0 10px;
    font-size: 20px;
}

.values {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.value {
    text-align: center;
    flex: 1;
    font-weight: bold;
}

.temp { color: #ef4444; }
.hum  { color: #2563eb; }
.soil { color: #7c3aed; }

canvas {
    width: 100%;
    height: 180px;
}
</style>
</head>

<body>

<header>Nhom_19_WSN</header>

<div class="toolbar">
    <button onclick="exportExcel()">ðŸ“Š Xuáº¥t Excel</button>
</div>

<div class="grid">
    <div class="card" id="node1"></div>
    <div class="card" id="node2"></div>
    <div class="card" id="node3"></div>
    <div class="card" id="node4"></div>
</div>

<script>
/* ================== Cáº¤U HÃŒNH ================== */
const TEMP_LIMIT = 18;
const MAX_POINTS = 10;

/* ================== KHá»žI Táº O ================== */
const nodes = [];
const charts = [];

for (let i = 1; i <= 4; i++) {
    const card = document.getElementById(`node${i}`);
    card.innerHTML = `
        <h3>Node ${i}</h3>
        <div class="values">
            <div class="value temp" id="t${i}">-- Â°C</div>
            <div class="value hum" id="h${i}">-- %</div>
            <div class="value soil" id="s${i}">-- %</div>
        </div>
        <canvas></canvas>
    `;

    nodes.push({
        id: i,
        time: [],
        temp: [],
        hum: [],
        soil: []
    });

    const ctx = card.querySelector("canvas").getContext("2d");
    charts.push(new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'Temp (Â°C)', data: [], borderColor: 'red', tension: 0.3 },
                { label: 'Hum (%)',  data: [], borderColor: 'blue', tension: 0.3 },
                { label: 'Soil (%)', data: [], borderColor: 'purple', tension: 0.3 }
            ]
        },
        options: {
            responsive: true,
            animation: false,
            scales: { y: { min: 0, max: 100 } }
        }
    }));
}

/* ================== NHáº¬N Dá»® LIá»†U ================== */
/*
ESP32 gá»­i JSON:
{
  node: 1,
  temp: 22.5,
  hum: 56.2,
  soil: 90
}
*/

const lastValue = {};

function onReceiveData(data) {
    const key = data.node;
    const signature = `${data.temp}-${data.hum}-${data.soil}`;
    if (lastValue[key] === signature) return;
    lastValue[key] = signature;

    updateNode(data.node - 1, data.temp, data.hum, data.soil);
}

function updateNode(i, temp, hum, soil) {
    const node = nodes[i];
    const now = new Date().toLocaleTimeString();

    node.time.push(now);
    node.temp.push(temp);
    node.hum.push(hum);
    node.soil.push(soil);

    if (node.time.length > MAX_POINTS) {
        node.time.shift();
        node.temp.shift();
        node.hum.shift();
        node.soil.shift();
    }

    document.getElementById(`t${i+1}`).innerText = temp + " Â°C";
    document.getElementById(`h${i+1}`).innerText = hum + " %";
    document.getElementById(`s${i+1}`).innerText = soil + " %";

    const card = document.getElementById(`node${i+1}`);
    temp > TEMP_LIMIT ? card.classList.add("alert")
                      : card.classList.remove("alert");

    const chart = charts[i];
    chart.data.labels = node.time;
    chart.data.datasets[0].data = node.temp;
    chart.data.datasets[1].data = node.hum;
    chart.data.datasets[2].data = node.soil;
    chart.update();
}

/* ================== XUáº¤T EXCEL ================== */
function exportExcel() {
    const rows = [["Node", "Time", "Temp", "Hum", "Soil"]];
    nodes.forEach(n => {
        for (let i = 0; i < n.time.length; i++) {
            rows.push([
                `Node ${n.id}`,
                n.time[i],
                n.temp[i],
                n.hum[i],
                n.soil[i]
            ]);
        }
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "WSN_Data");
    XLSX.writeFile(wb, "Nhom_19_WSN.xlsx");
}
</script>

</body>
</html>
