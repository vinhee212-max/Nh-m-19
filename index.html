<!doctype html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 Environmental Dashboard</title>

<!-- MQTT.js -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Segoe UI,system-ui;
  margin:0;
  background:#eef2ff;
}
header{
  background:#2563eb;
  color:white;
  padding:20px;
}
.status{
  display:flex;
  align-items:center;
  gap:10px;
}
.dot{
  width:12px;height:12px;border-radius:50%;
  background:red;
}
.ok{background:#22c55e;}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:20px;
}
.card{
  background:white;
  border-radius:14px;
  padding:20px;
  box-shadow:0 8px 20px rgba(0,0,0,.1);
}
.metrics{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-bottom:16px;
}
.metric{
  text-align:center;
}
.value{
  font-size:32px;
  font-weight:700;
}
.temp{color:#ef4444}
.hum{color:#3b82f6}
.soil{color:#8b5cf6}
</style>
</head>

<body>

<header>
  <h2>Environmental Monitoring Dashboard</h2>
  <div class="status">
    <div id="dot" class="dot"></div>
    <div id="connText">Disconnected</div>
  </div>
</header>

<div class="container">

<!-- NODE 1 -->
<div class="card">
<h3>Node 1</h3>
<div class="metrics">
  <div class="metric">
    <div>Nhiệt độ</div>
    <div id="t1" class="value temp">--</div>
  </div>
  <div class="metric">
    <div>Độ ẩm KK</div>
    <div id="h1" class="value hum">--</div>
  </div>
  <div class="metric">
    <div>Độ ẩm đất</div>
    <div id="s1" class="value soil">--</div>
  </div>
</div>
<canvas id="chart1"></canvas>
</div>

</div>

<script>
// ================= MQTT CONFIG =================
const HOST = "a736019f2a5e4fd98c17a4115be133f0.s1.eu.hivemq.cloud";
const USERNAME = "Nhom19WSN";
const PASSWORD = "Aenhom19@";
const brokerUrl = `wss://${HOST}:8884/mqtt`;

const TOPIC = "nodes/+/data"; // subscribe wildcard
// ===============================================

// UI
const dot = document.getElementById("dot");
const connText = document.getElementById("connText");

// DATA
const MAX = 40;
const labels = [];
const tempData = [];
const humData = [];
const soilData = [];

// CHART
const chart = new Chart(document.getElementById("chart1"),{
  type:"line",
  data:{
    labels,
    datasets:[
      {label:"Temp (°C)",data:tempData,borderColor:"#ef4444",tension:.4},
      {label:"Hum (%)",data:humData,borderColor:"#3b82f6",tension:.4},
      {label:"Soil (%)",data:soilData,borderColor:"#8b5cf6",tension:.4}
    ]
  },
  options:{responsive:true}
});

// MQTT CLIENT
const client = mqtt.connect(brokerUrl,{
  username:USERNAME,
  password:PASSWORD,
  reconnectPeriod:2000
});

client.on("connect",()=>{
  dot.classList.add("ok");
  connText.textContent="Connected";
  client.subscribe(TOPIC);
});

client.on("close",()=>{
  dot.classList.remove("ok");
  connText.textContent="Disconnected";
});

client.on("message",(topic,msg)=>{
  try{
    const json = JSON.parse(msg.toString());
    if(!json.data || !json.data[0]) return;

    const d = json.data[0];
    const t = d.t;
    const h = d.h;
    const s = d.s;

    document.getElementById("t1").textContent = t.toFixed(1)+" °C";
    document.getElementById("h1").textContent = h.toFixed(1)+" %";
    document.getElementById("s1").textContent = s.toFixed(1)+" %";

    const time = new Date().toLocaleTimeString();
    labels.push(time);
    tempData.push(t);
    humData.push(h);
    soilData.push(s);

    if(labels.length>MAX){
      labels.shift();
      tempData.shift();
      humData.shift();
      soilData.shift();
    }

    chart.update();

  }catch(e){
    console.error(e);
  }
});
</script>

</body>
</html>
